<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Marex Flexi 21 – Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #0f172a;
            --bg-elevated: #1e293b;
            --bg-elevated-soft: #111827;
            --border-subtle: #1f2937;
            --accent: #38bdf8;
            --accent-soft: rgba(56, 189, 248, 0.1);
            --accent-strong: #0ea5e9;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --danger: #f97373;
            --success: #4ade80;
            --warning: #facc15;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
                "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #1f2937, #020617 60%);
            color: var(--text-main);
        }

        .page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        header {
            border-radius: 16px;
            padding: 16px 20px;
            background: linear-gradient(135deg, #020617, #0b1120);
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
            margin-bottom: 16px;
        }

        header h1 {
            margin: 0;
            font-size: 20px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--accent-strong);
        }

        .header-top {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-top: 4px;
        }

        .yacht-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            font-size: 13px;
            color: var(--text-muted);
        }

        .yacht-meta label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #6b7280;
        }

        .yacht-meta input {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            padding: 4px 10px;
            color: var(--text-main);
            font-size: 13px;
            min-width: 90px;
        }

        .yacht-meta input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent-soft);
        }

        .api-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .api-meta input {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            padding: 4px 10px;
            color: var(--text-main);
            font-size: 13px;
            min-width: 150px;
        }

        .api-meta input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent-soft);
        }

        .connection-pill {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            padding: 4px 10px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--danger);
        }

        .connection-pill.connected .connection-dot {
            background: var(--success);
        }

        .connection-pill.error .connection-dot {
            background: var(--danger);
        }

        .connection-pill span {
            color: var(--text-muted);
        }

        .scene-strip {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }

        .scene-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .scene-btn {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(15, 23, 42, 0.9);
            color: var(--text-muted);
            padding: 6px 14px;
            font-size: 12px;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.15s, color 0.15s, border-color 0.15s,
                box-shadow 0.15s;
        }

        .scene-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent-soft);
        }

        .scene-btn.active {
            background: linear-gradient(135deg, #38bdf8, #0ea5e9);
            color: #020617;
            border-color: transparent;
            box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.2);
        }

        .presence {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            font-size: 12px;
        }

        .presence-label {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #6b7280;
        }

        .presence-buttons {
            display: inline-flex;
            border-radius: 999px;
            padding: 2px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.5);
        }

        .presence-btn {
            border-radius: 999px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
        }

        .presence-btn.active {
            background: var(--accent-soft);
            color: var(--accent-strong);
        }

        .ai-mode-text {
            color: var(--text-muted);
            font-size: 12px;
        }

        .last-event {
            font-size: 12px;
            color: var(--text-muted);
        }

        .last-event strong {
            color: var(--text-main);
        }

        main {
            border-radius: 16px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.9);
            padding: 10px 16px 16px;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            border-bottom: 1px solid var(--border-subtle);
            margin-bottom: 12px;
        }

        .tab-btn {
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 6px 14px;
            font-size: 13px;
            cursor: pointer;
            background: transparent;
            color: var(--text-muted);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .tab-btn.active {
            background: var(--accent-soft);
            color: var(--accent-strong);
            border-color: rgba(56, 189, 248, 0.4);
        }

        .tab-btn span {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .tab-content {
            display: none;
            margin-top: 12px;
        }

<<<<<<< HEAD
        .tab-content.active {
            display: block;
        }

        .tab-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .tab-toolbar-title {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        .btn {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            padding: 5px 12px;
            font-size: 12px;
            background: rgba(15, 23, 42, 0.9);
            color: var(--text-main);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn.secondary {
            border-color: rgba(55, 65, 81, 0.9);
            background: rgba(15, 23, 42, 0.8);
            color: var(--text-muted);
        }

        .btn.danger {
            border-color: rgba(248, 113, 113, 0.5);
            color: var(--danger);
        }
=======
    .sensors-list {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:4px;
    }
    .sensor-item {
      padding:4px 5px;
      border-radius:6px;
      border:1px solid #111827;
      background:#020617;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:4px;
    }
    body.light-theme .sensor-item {
      background:#ffffff;
      border-color:#e5e7eb;
    }
    .sensor-main {
      display:flex;
      flex-direction:column;
      gap:1px;
    }
    .sensor-name {
      font-size:11px;
      font-weight:500;
      color:#e5e7eb;
    }
    body.light-theme .sensor-name { color:#111827; }
    .sensor-meta {
      font-size:10px;
      color:#6b7280;
    }
    .sensor-state {
      font-size:10px;
      padding:4px 6px;
      border-radius:999px;
      border:1px solid #1f2937;
      min-width:56px;
      text-align:center;
      background:#020617;
      color:#9ca3af;
    }
    .sensor-state.on {
      border-color:#22c55e;
      color:#bbf7d0;
    }
    .sensor-state.alarm {
      border-color:#f97316;
      color:#fed7aa;
    }
    body.light-theme .sensor-state {
      background:#f9fafb;
      border-color:#d1d5db;
      color:#374151;
    }

    /* EVENTS / ALARMS */
>>>>>>> parent of eab19c4 (1)

        .btn.small {
            padding: 4px 10px;
            font-size: 11px;
        }

        .device-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .device-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            border-radius: 10px;
            background: var(--bg-elevated);
            border: 1px solid rgba(31, 41, 55, 0.8);
        }

        .device-row.sensor {
            background: var(--bg-elevated-soft);
        }

        .device-main {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .device-name {
            font-size: 13px;
        }

        .device-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .device-meta span + span::before {
            content: "•";
            margin: 0 4px;
            opacity: 0.4;
        }

        .device-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            color: var(--text-muted);
        }

        .badge.ai {
            border-color: rgba(56, 189, 248, 0.5);
            color: var(--accent-strong);
        }

        .badge.sensor {
            border-color: rgba(148, 163, 184, 0.6);
        }

        .toggle {
            position: relative;
            width: 38px;
            height: 20px;
            border-radius: 999px;
            background: #111827;
            border: 1px solid rgba(55, 65, 81, 0.9);
            cursor: pointer;
            flex-shrink: 0;
        }

        .toggle-thumb {
            position: absolute;
            top: 1px;
            left: 1px;
            width: 16px;
            height: 16px;
            border-radius: 999px;
            background: #6b7280;
            transition: transform 0.15s, background 0.15s;
        }

        .toggle.on {
            background: rgba(45, 212, 191, 0.1);
            border-color: rgba(52, 211, 153, 0.8);
        }

        .toggle.on .toggle-thumb {
            transform: translateX(16px);
            background: #22c55e;
        }

        .toggle-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        .status-list,
        .log-list,
        .alarm-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .status-item,
        .log-item,
        .alarm-item {
            border-radius: 10px;
            padding: 6px 10px;
            background: var(--bg-elevated);
            border: 1px solid rgba(31, 41, 55, 0.9);
            font-size: 12px;
        }

        .status-meta,
        .log-meta,
        .alarm-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .status-body,
        .log-body,
        .alarm-body {
            font-size: 12px;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .pill.type-ai {
            background: rgba(56, 189, 248, 0.08);
            color: var(--accent-strong);
        }

        .pill.type-alarm {
            background: rgba(248, 113, 113, 0.08);
            color: var(--danger);
        }

        .pill.type-device {
            background: rgba(52, 211, 153, 0.08);
            color: var(--success);
        }

        .pill.type-scene {
            background: rgba(216, 180, 254, 0.08);
            color: #c4b5fd;
        }

        .pill.type-chat {
            background: rgba(129, 140, 248, 0.08);
            color: #a5b4fc;
        }

        .muted {
            color: var(--text-muted);
        }

        .error-text {
            color: var(--danger);
            font-size: 12px;
        }

        .chat-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
            gap: 12px;
        }

        @media (max-width: 768px) {
            .chat-layout {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .chat-input-box {
            border-radius: 12px;
            padding: 8px;
            background: var(--bg-elevated);
            border: 1px solid rgba(31, 41, 55, 0.9);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            max-height: 240px;
            border-radius: 8px;
            border: 1px solid rgba(31, 41, 55, 0.9);
            background: #020617;
            color: var(--text-main);
            padding: 6px 8px;
            font-size: 13px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent-soft);
        }

        .chat-history {
            border-radius: 12px;
            padding: 8px;
            background: var(--bg-elevated);
            border: 1px solid rgba(31, 41, 55, 0.9);
            font-size: 12px;
            max-height: 260px;
            overflow-y: auto;
        }

        .chat-entry {
            margin-bottom: 8px;
        }

        .chat-entry strong {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
        }

        .chat-entry p {
            margin: 2px 0 0;
        }

        .section-split {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 12px;
        }

        @media (max-width: 800px) {
            .section-split {
                grid-template-columns: minmax(0, 1fr);
            }
        }
    </style>
</head>
<body>
<div class="page">
    <header>
        <h1>Marex Flexi 21 – Control Panel</h1>

<<<<<<< HEAD
        <div class="header-top">
            <div class="yacht-meta">
                <div>
                    <label for="yachtIdInput">Yacht ID</label>
                    <input id="yachtIdInput" type="text" value="marex-21-001" />
                </div>
                <div class="api-meta">
                    <label for="apiBaseInput">API</label>
                    <input id="apiBaseInput" type="text" value="" placeholder="(blank = same origin)" />
                    <div id="connectionStatus" class="connection-pill">
                        <span class="connection-dot"></span>
                        <span>Idle</span>
                    </div>
                </div>
                <div class="last-event">
                    Last: <strong id="lastEventText">none</strong>
                </div>
=======
      <!-- TABS -->
      <div class="tabs-bar">
        <button class="tab-btn active" data-page="controls">Controls</button>
        <button class="tab-btn" data-page="status">Status & Tests</button>
        <button class="tab-btn" data-page="events">Events</button>
        <button class="tab-btn" data-page="alarms">Alarms</button>
      </div>

      <!-- ALARM BANNER -->
      <div id="alarmBanner" class="alarm-banner ok">
        <span class="alarm-banner-label">Alarms</span>
        <span id="alarmBannerText">No active alarms.</span>
      </div>

      <!-- PAGES -->
      <div class="page-container">
        <!-- CONTROLS -->
        <div class="page active" id="page-controls">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Controls</div>
              <div class="card-header-right">
                <span id="summaryLine">–</span>
                <button id="refreshDevicesBtn" class="small-btn">Refresh</button>
              </div>
            </div>
            <div class="card-body">
              <div id="sceneButtons" class="scene-row"></div>
              <div id="deviceContainer" class="device-grid"></div>
            </div>
          </div>
        </div>

        <!-- STATUS -->
        <div class="page" id="page-status">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Status & Tests</div>
              <div class="card-header-right">
                <button id="refreshSensorsBtn" class="small-btn">Refresh</button>
                <button id="bilgeTestBtn" class="small-btn">Bilge Test</button>
                <button id="batteryTestBtn" class="small-btn">Battery Test</button>
                <button id="fuelTestBtn" class="small-btn">Fuel Low Test</button>
              </div>
            </div>
            <div class="card-body">
              <div id="sensorContainer" class="sensors-list"></div>
            </div>
          </div>
        </div>

        <!-- EVENTS -->
        <div class="page" id="page-events">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Events</div>
              <div class="card-header-right">
                <button id="refreshEventsBtn" class="small-btn">Refresh</button>
              </div>
            </div>
            <div class="card-body">
              <div id="eventsList" class="events-list"></div>
>>>>>>> parent of eab19c4 (1)
            </div>

            <div class="presence">
                <span class="presence-label">Presence</span>
                <div class="presence-buttons">
                    <button id="presenceOnboard" class="presence-btn" type="button"
                            onclick="setPresence('onboard')">
                        Onboard
                    </button>
                    <button id="presenceUnattended" class="presence-btn" type="button"
                            onclick="setPresence('unattended')">
                        Unattended
                    </button>
                </div>
                <span class="ai-mode-text" id="aiModeText">AI mode: (loading…)</span>
            </div>
        </div>

<<<<<<< HEAD
        <div class="scene-strip">
            <div class="scene-buttons" id="sceneButtons">
                <!-- Scenes loaded from backend -->
=======
        <!-- ALARMS PAGE -->
        <div class="page" id="page-alarms">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Alarm History</div>
              <div class="card-header-right">
                <button id="refreshAlarmsBtn" class="small-btn">Refresh</button>
              </div>
>>>>>>> parent of eab19c4 (1)
            </div>
            <button class="btn small" type="button" onclick="refreshAll()">
                ⟳ Refresh all
            </button>
        </div>
    </header>

    <main>
        <div class="tabs">
            <button class="tab-btn active" data-tab="controls" type="button" onclick="showTab('controls')">
                <span>Controls</span>
            </button>
            <button class="tab-btn" data-tab="status" type="button" onclick="showTab('status')">
                <span>Status &amp; Tests</span>
            </button>
            <button class="tab-btn" data-tab="ai-watch" type="button" onclick="showTab('ai-watch')">
                <span>AI Watchkeeper</span>
            </button>
            <button class="tab-btn" data-tab="ai-chat" type="button" onclick="showTab('ai-chat')">
                <span>AI Chat</span>
            </button>
            <button class="tab-btn" data-tab="alarms" type="button" onclick="showTab('alarms')">
                <span>Alarms</span>
            </button>
        </div>

        <!-- CONTROLS TAB -->
        <section id="tab-controls" class="tab-content active">
            <div class="tab-toolbar">
                <div class="tab-toolbar-title">Controls</div>
                <div>
                    <button class="btn small" type="button" onclick="loadDevices()">⟳ Refresh</button>
                </div>
            </div>
            <div id="controlsError" class="error-text"></div>
            <div id="deviceList" class="device-list"></div>
        </section>

        <!-- STATUS & TESTS TAB -->
        <section id="tab-status" class="tab-content">
            <div class="tab-toolbar">
                <div class="tab-toolbar-title">Status &amp; Tests</div>
                <div>
                    <button class="btn small" type="button" onclick="loadEvents()">⟳ Refresh</button>
                </div>
            </div>
            <div id="statusError" class="error-text"></div>
            <div id="statusEvents" class="status-list"></div>
        </section>

        <!-- AI WATCHKEEPER TAB -->
        <section id="tab-ai-watch" class="tab-content">
            <div class="tab-toolbar">
                <div class="tab-toolbar-title">AI Watchkeeper</div>
                <div>
                    <button class="btn small" type="button" onclick="loadAiLogs()">⟳ Refresh logs</button>
                </div>
            </div>
            <div id="aiLogsError" class="error-text"></div>
            <div id="aiLogs" class="log-list"></div>
        </section>

        <!-- AI CHAT TAB -->
        <section id="tab-ai-chat" class="tab-content">
            <div class="tab-toolbar">
                <div class="tab-toolbar-title">AI Watchkeeper – Chat</div>
            </div>
            <div class="chat-layout">
                <div class="chat-input-box">
                    <div class="muted" style="font-size: 12px; margin-bottom: 4px;">
                        Ask the AI watchkeeper a question:
                    </div>
                    <textarea id="chatInput" placeholder="e.g. What did you do this hour, and is anything abnormal?"></textarea>
                    <div style="display:flex; justify-content:flex-end; gap:8px; align-items:center;">
                        <span id="chatError" class="error-text"></span>
                        <button class="btn small" type="button" onclick="sendChat()">
                            Ask
                        </button>
                    </div>
                </div>
                <div class="chat-history" id="chatHistory">
                    <!-- Chat history entries -->
                </div>
            </div>
        </section>

        <!-- ALARMS TAB -->
        <section id="tab-alarms" class="tab-content">
            <div class="tab-toolbar">
                <div class="tab-toolbar-title">Alarms</div>
                <div>
                    <button class="btn small secondary" type="button" onclick="acknowledgeAlarms()">
                        ✓ Acknowledge
                    </button>
                    <button class="btn small danger" type="button" onclick="clearTestAlarms()">
                        ✖ Clear test alarms
                    </button>
                    <button class="btn small" type="button" onclick="loadEvents()">⟳ Refresh</button>
                </div>
            </div>
            <div id="alarmsError" class="error-text"></div>

<<<<<<< HEAD
            <div class="section-split">
                <div>
                    <div class="muted" style="font-size: 12px; margin-bottom: 4px;">
                        Active alarms
                    </div>
                    <div id="activeAlarms" class="alarm-list">
                        <div class="alarm-item">
                            <div class="alarm-body muted">No active alarms.</div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="muted" style="font-size: 12px; margin-bottom: 4px;">
                        Alarm history
                    </div>
                    <div id="alarmHistory" class="alarm-list"></div>
                </div>
            </div>
        </section>
    </main>
</div>

<script>
    const DEFAULT_YACHT_ID = "marex-21-001";
    const DEFAULT_API_BASE = ""; // blank = same origin
=======
    document.getElementById("apiBase").textContent  = window.location.origin;
    document.getElementById("yachtName").textContent = yachtId;
>>>>>>> parent of eab19c4 (1)

    let cachedEvents = [];
    let cachedAiMode = null;

    function getYachtId() {
        const el = document.getElementById("yachtIdInput");
        const v = (el && el.value.trim()) || "";
        return v || DEFAULT_YACHT_ID;
    }

<<<<<<< HEAD
    function getApiBase() {
        const el = document.getElementById("apiBaseInput");
        let v = (el && el.value.trim()) || DEFAULT_API_BASE;
        // strip trailing slash, keep protocol/host if present
        if (v.endsWith("/")) {
            v = v.replace(/\/+$/, "");
        }
        return v;
    }
=======
    /* TABS */

    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const page = btn.getAttribute("data-page");
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
        document.getElementById("page-" + page).classList.add("active");
      });
    });

    /* MODE BUTTONS */

    document.querySelectorAll(".mode-pill").forEach(btn => {
      btn.addEventListener("click", () => {
        const sceneId = btn.getAttribute("data-scene");
        activateScene(sceneId, btn.textContent.trim());
        document.querySelectorAll(".mode-pill").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      });
    });

    /* HEADER BUTTONS */

    document.getElementById("refreshDevicesBtn").addEventListener("click", () => {
      loadDevices();
      loadScenes();
    });
    document.getElementById("refreshSensorsBtn").addEventListener("click", loadDevices);
    document.getElementById("refreshEventsBtn").addEventListener("click", loadEvents);
    document.getElementById("refreshAlarmsBtn").addEventListener("click", loadAlarmEvents);

    document.getElementById("bilgeTestBtn").addEventListener("click", runBilgeTest);
    document.getElementById("batteryTestBtn").addEventListener("click", runBatteryTest);
    document.getElementById("fuelTestBtn").addEventListener("click", runFuelTest);
>>>>>>> parent of eab19c4 (1)

    function buildUrl(path) {
        const base = getApiBase();
        if (!base) {
            return path;
        }
        return base + path;
    }

<<<<<<< HEAD
    async function apiGet(path) {
        const url = buildUrl(path);
        const conn = document.getElementById("connectionStatus");
        if (conn) {
            conn.classList.remove("error");
            conn.classList.remove("connected");
            conn.querySelector("span:last-child").textContent = "Query…";
        }
        const res = await fetch(url);
        if (!res.ok) {
            throw new Error("GET " + url + " -> " + res.status);
        }
        const json = await res.json();
        if (conn) {
            conn.classList.add("connected");
            conn.querySelector("span:last-child").textContent = "OK";
        }
        return json;
    }

    async function apiPost(path, body) {
        const url = buildUrl(path);
        const conn = document.getElementById("connectionStatus");
        if (conn) {
            conn.classList.remove("error");
            conn.classList.remove("connected");
            conn.querySelector("span:last-child").textContent = "Sending…";
        }
        const res = await fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body || {})
        });
        if (!res.ok) {
            throw new Error("POST " + url + " -> " + res.status);
        }
        const json = await res.json();
        if (conn) {
            conn.classList.add("connected");
            conn.querySelector("span:last-child").textContent = "OK";
        }
        return json;
    }

    function showError(id, message) {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = message || "";
        }
        const conn = document.getElementById("connectionStatus");
        if (conn) {
            conn.classList.remove("connected");
            conn.classList.add("error");
            conn.querySelector("span:last-child").textContent = "Error";
        }
    }

    function clearError(id) {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = "";
        }
    }

    function showTab(name) {
        document.querySelectorAll(".tab-btn").forEach(btn => {
            const active = btn.getAttribute("data-tab") === name;
            if (active) {
                btn.classList.add("active");
            } else {
                btn.classList.remove("active");
            }
        });
        document.querySelectorAll(".tab-content").forEach(sec => {
            if (sec.id === "tab-" + name) {
                sec.classList.add("active");
            } else {
                sec.classList.remove("active");
            }
        });
    }

    // --- SCENES (TOP-STRIP) ---

    async function loadScenes() {
        const yachtId = encodeURIComponent(getYachtId());
        const container = document.getElementById("sceneButtons");
        if (!container) return;
        container.innerHTML = "";
        try {
            const scenes = await apiGet("/yachts/" + yachtId + "/scenes/");
            if (!Array.isArray(scenes) || scenes.length === 0) {
                // Fallback static pills
                ["Underway", "At Anchor", "Harbour"].forEach((name, idx) => {
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "scene-btn";
                    btn.textContent = name;
                    btn.onclick = () => console.log("Scene '" + name + "' not configured in DB");
                    container.appendChild(btn);
                });
                return;
            }
            scenes.forEach(scene => {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "scene-btn";
                btn.textContent = scene.name || scene.id;
                btn.dataset.sceneId = scene.id;
                btn.onclick = () => activateScene(scene.id);
                container.appendChild(btn);
            });
        } catch (err) {
            console.error("Failed to load scenes", err);
            // Show static fallback
            ["Underway", "At Anchor", "Harbour"].forEach(name => {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "scene-btn";
                btn.textContent = name;
                btn.onclick = () => console.log("Scene '" + name + "' not configured in DB");
                container.appendChild(btn);
            });
        }
    }

    async function activateScene(sceneId) {
        const yachtId = encodeURIComponent(getYachtId());
        try {
            await apiPost("/yachts/" + yachtId + "/scenes/" + encodeURIComponent(sceneId) + "/activate", {
                source: "user_ui"
            });
            highlightActiveScene(sceneId);
            await loadEvents(); // update history / last event
        } catch (err) {
            console.error("Failed to activate scene", err);
            alert("Failed to activate scene '" + sceneId + "'. Check backend logs.");
        }
    }

    function highlightActiveScene(sceneId) {
        document.querySelectorAll(".scene-btn").forEach(btn => {
            if (btn.dataset.sceneId === sceneId) {
                btn.classList.add("active");
            } else {
                btn.classList.remove("active");
            }
        });
    }

    // --- AI MODE / PRESENCE (uses /system/ai-mode) ---

    function updatePresenceUI(aiMode) {
        cachedAiMode = aiMode;
        const onboardBtn = document.getElementById("presenceOnboard");
        const unattendedBtn = document.getElementById("presenceUnattended");
        const text = document.getElementById("aiModeText");

        let presence = "onboard";
        if (aiMode === "autonomous") {
            presence = "unattended";
        }

        if (onboardBtn && unattendedBtn) {
            if (presence === "onboard") {
                onboardBtn.classList.add("active");
                unattendedBtn.classList.remove("active");
            } else {
                unattendedBtn.classList.add("active");
                onboardBtn.classList.remove("active");
            }
        }

        if (text) {
            text.textContent = "AI mode: " + (aiMode || "unknown");
        }
    }

    async function loadAiMode() {
        const yachtId = encodeURIComponent(getYachtId());
        try {
            const data = await apiGet("/yachts/" + yachtId + "/system/ai-mode");
            const mode = (data && data.mode) || "monitor";
            updatePresenceUI(mode);
        } catch (err) {
            console.error("Failed to load AI mode", err);
            updatePresenceUI("(error)");
        }
    }

    async function setAiMode(aiMode) {
        const yachtId = encodeURIComponent(getYachtId());
        try {
            await apiPost("/yachts/" + yachtId + "/system/ai-mode", { mode: aiMode });
            updatePresenceUI(aiMode);
        } catch (err) {
            console.error("Failed to set AI mode", err);
            alert("Failed to set AI mode (" + aiMode + "). Check backend.");
        }
    }

    // Onboard / Unattended mapping into AiMode
    function setPresence(presence) {
        if (presence === "unattended") {
            // Full control when unattended
            setAiMode("autonomous");
        } else {
            // Onboard = assist mode (AI still allowed but less aggressive at backend level)
            setAiMode("assist");
        }
    }

    // --- DEVICES / CONTROLS ---
=======
    /* DEVICES & SENSORS */

    async function loadDevices() {
      try {
        const res = await fetch(`${apiBase}/yachts/${yachtId}/devices/`);
        if (!res.ok) throw new Error("Failed to load devices");
        const devices = await res.json();
        renderDevices(devices);
        renderSensors(devices);
        updateSummary(devices);
        updateAlarmBanner(devices);
        setLastAction("Devices refreshed");
      } catch (err) {
        console.error(err);
        setLastAction("Error loading devices");
      }
    }

    function updateSummary(devices) {
      const controllable = devices.filter(d => d.type !== "sensor" && !READONLY_IDS.has(d.id));
      const onCount  = controllable.filter(d => d.state === true).length;
      const pumpsOn  = controllable.filter(d => d.type === "pump" && d.state === true).length;
      const lightsOn = controllable.filter(d => d.type === "light" && d.state === true).length;
      summaryLineEl.textContent = `${onCount} outputs ON · ${lightsOn} lights · ${pumpsOn} pumps`;
    }
>>>>>>> parent of eab19c4 (1)

    function renderDevices(devices) {
        const list = document.getElementById("deviceList");
        if (!list) return;
        list.innerHTML = "";
        if (!Array.isArray(devices) || devices.length === 0) {
            const div = document.createElement("div");
            div.className = "muted";
            div.textContent = "No devices configured.";
            list.appendChild(div);
            return;
        }

        devices.forEach(dev => {
            const row = document.createElement("div");
            row.className = "device-row";
            if (dev.type === "sensor") {
                row.classList.add("sensor");
            }

            const left = document.createElement("div");
            left.className = "device-main";

            const name = document.createElement("div");
            name.className = "device-name";
            name.textContent = dev.name || dev.id;

            const meta = document.createElement("div");
            meta.className = "device-meta";
            const zoneSpan = document.createElement("span");
            zoneSpan.textContent = dev.zone || "no-zone";
            meta.appendChild(zoneSpan);

            const typeSpan = document.createElement("span");
            typeSpan.textContent = dev.type || "unknown";
            meta.appendChild(typeSpan);

            left.appendChild(name);
            left.appendChild(meta);

            const right = document.createElement("div");
            right.className = "device-right";

            if (dev.type === "sensor") {
                const sensorBadge = document.createElement("span");
                sensorBadge.className = "badge sensor";
                sensorBadge.textContent = dev.state ? "ON" : "OFF";
                right.appendChild(sensorBadge);
            } else {
                const toggle = document.createElement("div");
                toggle.className = "toggle";
                if (dev.state === true) {
                    toggle.classList.add("on");
                }

                const thumb = document.createElement("div");
                thumb.className = "toggle-thumb";
                toggle.appendChild(thumb);

                toggle.onclick = () => {
                    const targetState = !dev.state;
                    setDeviceState(dev.id, targetState);
                };
                right.appendChild(toggle);

                const label = document.createElement("div");
                label.className = "toggle-label";
                label.textContent = dev.state ? "ON" : "OFF";
                right.appendChild(label);
            }

            if (dev.ai_control) {
                const aiBadge = document.createElement("span");
                aiBadge.className = "badge ai";
                aiBadge.textContent = "AI " + String(dev.ai_control).toLowerCase();
                right.appendChild(aiBadge);
            }

            row.appendChild(left);
            row.appendChild(right);
            list.appendChild(row);
        });
    }

<<<<<<< HEAD
    async function loadDevices() {
        clearError("controlsError");
        const yachtId = encodeURIComponent(getYachtId());
        try {
            const devices = await apiGet("/yachts/" + yachtId + "/devices/");
            renderDevices(devices);
        } catch (err) {
            console.error("Failed to load devices", err);
            showError("controlsError", "Failed to load devices.");
        }
=======
    function renderSensors(devices) {
      sensorContainer.innerHTML = "";

      const sensors = devices.filter(dev =>
        dev.type === "sensor" || READONLY_IDS.has(dev.id)
      );

      if (sensors.length === 0) {
        sensorContainer.textContent = "No sensors configured.";
        return;
      }

      sensors
        .sort((a, b) => {
          if (a.zone === b.zone) return a.name.localeCompare(b.name);
          return a.zone.localeCompare(b.zone);
        })
        .slice(0, 16)
        .forEach(dev => {
          const item = document.createElement("div");
          item.className = "sensor-item";

          const main = document.createElement("div");
          main.className = "sensor-main";

          const name = document.createElement("div");
          name.className = "sensor-name";
          name.textContent = dev.name;

          const meta = document.createElement("div");
          meta.className = "sensor-meta";
          meta.textContent = `${dev.zone} · ${dev.id}`;

          main.appendChild(name);
          main.appendChild(meta);

          const state = document.createElement("div");
          state.className = "sensor-state";

          let text = "–";
          if (dev.state === true) {
            text = "ON";
            state.classList.add("on");
          } else if (dev.state === false) {
            text = "OFF";
          } else if (dev.state !== null && dev.state !== undefined) {
            text = String(dev.state);
          }

          if (dev.id.includes("bilge") || dev.id.includes("battery_low")) {
            if (dev.state === true) state.classList.add("alarm");
          }

          state.textContent = text;

          item.appendChild(main);
          item.appendChild(state);
          sensorContainer.appendChild(item);
        });
>>>>>>> parent of eab19c4 (1)
    }

    async function setDeviceState(deviceId, newState) {
        const yachtId = encodeURIComponent(getYachtId());
        try {
            await apiPost("/yachts/" + yachtId + "/devices/" + encodeURIComponent(deviceId) + "/state", {
                state: !!newState,
                source: "user_ui"
            });
            await loadDevices();
            await loadEvents(); // to update last event
        } catch (err) {
            console.error("Failed to set device state", err);
            alert("Failed to change device '" + deviceId + "'.");
        }
    }

<<<<<<< HEAD
    // --- EVENTS / STATUS / LAST ---

    function renderEvents(events) {
        const list = document.getElementById("statusEvents");
        if (!list) return;
        list.innerHTML = "";
=======
    async function setSensorValue(deviceId, value) {
      try {
        const res = await fetch(`${apiBase}/yachts/${yachtId}/devices/${deviceId}/state`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ state: value, source: "web_ui_test" })
        });
        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`Failed to set sensor value: ${errText}`);
        }
        await loadDevices();
        await loadEvents();
        await loadAlarmEvents();
      } catch (err) {
        console.error(err);
        setLastAction(`Error setting ${deviceId}`);
      }
    }

    /* ALARM BANNER LOGIC */

    function updateAlarmBanner(devices) {
      const active = devices.filter(
        d => ALARM_IDS.has(d.id) && d.state === true
      );

      alarmBanner.classList.remove("ok","alarm");

      if (active.length === 0) {
        alarmBanner.classList.add("ok");
        alarmBannerText.textContent = "No active alarms.";
      } else {
        alarmBanner.classList.add("alarm");
        const names = active.map(d => d.name || d.id).join(" · ");
        alarmBannerText.textContent = names;
      }
    }

    /* TESTS */

    function pulseDevice(deviceId, durationMs = 5000) {
      setDeviceState(deviceId, true);
      setLastAction(`TEST: ${deviceId} ON`);
      setTimeout(() => setDeviceState(deviceId, false), durationMs);
    }

    function runBilgeTest() {
      pulseDevice("bilge_float_high", 5000);
      pulseDevice("bilge_float_auto", 5000);
    }

    function runBatteryTest() {
      pulseDevice("battery_low_alarm", 5000);
    }

    function runFuelTest() {
      setSensorValue("fuel_tank_level", 10);
      setLastAction("Fuel level test → 10");
      setTimeout(() => setSensorValue("fuel_tank_level", 60), 8000);
    }

    /* SCENES */

    async function loadScenes() {
      try {
        const res = await fetch(`${apiBase}/yachts/${yachtId}/scenes`);
        if (!res.ok) throw new Error("Failed to load scenes");
        const scenes = await res.json();
        renderScenes(scenes);
      } catch (err) {
        console.error(err);
        setLastAction("Error loading scenes");
      }
    }

    function renderScenes(scenes) {
      sceneButtons.innerHTML = "";
      scenes.forEach(scene => {
        const btn = document.createElement("button");
        btn.className = "scene-btn";
        btn.addEventListener("click", () => activateScene(scene.id, scene.name));

        const name = document.createElement("div");
        name.className = "scene-name";
        name.textContent = scene.name;

        const desc = document.createElement("div");
        desc.className = "scene-desc";
        desc.textContent = scene.description || scene.id;

        btn.appendChild(name);
        btn.appendChild(desc);
        sceneButtons.appendChild(btn);
      });
    }

    async function activateScene(sceneId, sceneName) {
      try {
        const res = await fetch(`${apiBase}/yachts/${yachtId}/scenes/${sceneId}/activate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ source: "web_ui" })
        });
        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`Failed to activate scene: ${errText}`);
        }
        setLastAction(`Scene: ${sceneName}`);
        await loadDevices();
        await loadEvents();
        await loadAlarmEvents();
      } catch (err) {
        console.error(err);
        setLastAction(`Error activating scene: ${sceneName}`);
      }
    }

    /* EVENTS */

    async function loadEvents() {
      try {
        const res = await fetch(`${apiBase}/yachts/${yachtId}/events?limit=50`);
        if (!res.ok) throw new Error("Failed to load events");
        const events = await res.json();
        renderEvents(events);
      } catch (err) {
        console.error(err);
        setLastAction("Error loading events");
      }
    }

    function renderEvents(events) {
      eventsList.innerHTML = "";
      events.slice(0, 15).forEach(ev => {
        const item = document.createElement("div");
        item.className = "event-item";
>>>>>>> parent of eab19c4 (1)

        if (!Array.isArray(events) || events.length === 0) {
            const div = document.createElement("div");
            div.className = "muted";
            div.textContent = "No events logged yet.";
            list.appendChild(div);
            return;
        }

        events.forEach(ev => {
            const item = document.createElement("div");
            item.className = "status-item";

            const meta = document.createElement("div");
            meta.className = "status-meta";

            const ts = document.createElement("span");
            ts.textContent = ev.timestamp || ev.generated_at || "";
            meta.appendChild(ts);

            const type = document.createElement("span");
            type.textContent = ev.type || "event";
            meta.appendChild(type);

            const src = document.createElement("span");
            src.textContent = ev.source || "";
            meta.appendChild(src);

            item.appendChild(meta);

            const body = document.createElement("div");
            body.className = "status-body";
            const details = ev.details || {};
            try {
                body.textContent = JSON.stringify(details);
            } catch (e) {
                body.textContent = String(details);
            }

            item.appendChild(body);
            list.appendChild(item);
        });
    }

<<<<<<< HEAD
    function updateLastEvent(events) {
        const el = document.getElementById("lastEventText");
        if (!el) return;
        if (!Array.isArray(events) || events.length === 0) {
            el.textContent = "none";
            return;
        }
        const ev = events[0];
        const ts = ev.timestamp || ev.generated_at || "";
        const type = ev.type || "event";
        el.textContent = ts + " – " + type;
    }

    function renderAlarmsFromEvents(events) {
        const activeEl = document.getElementById("activeAlarms");
        const historyEl = document.getElementById("alarmHistory");
        if (!activeEl || !historyEl) return;

        activeEl.innerHTML = "";
        historyEl.innerHTML = "";

        const alarmEvents = (events || []).filter(e =>
            String(e.type || "").toLowerCase().includes("alarm")
        );

        if (alarmEvents.length === 0) {
            const item = document.createElement("div");
            item.className = "alarm-item";
            const body = document.createElement("div");
            body.className = "alarm-body muted";
            body.textContent = "No active alarms.";
            item.appendChild(body);
            activeEl.appendChild(item);
            return;
        }

        alarmEvents.forEach((ev, idx) => {
            const item = document.createElement("div");
            item.className = "alarm-item";

            const meta = document.createElement("div");
            meta.className = "alarm-meta";

            const pill = document.createElement("span");
            pill.className = "pill type-alarm";
            pill.textContent = ev.type || "alarm";
            meta.appendChild(pill);

            const ts = document.createElement("span");
            ts.style.marginLeft = "6px";
            ts.textContent = ev.timestamp || "";
            meta.appendChild(ts);

            item.appendChild(meta);

            const body = document.createElement("div");
            body.className = "alarm-body";
            const details = ev.details || {};
            try {
                body.textContent = JSON.stringify(details);
            } catch (e) {
                body.textContent = String(details);
            }

            item.appendChild(body);

            // For now just treat all as "history", and first few as "active"
            if (idx < 3) {
                activeEl.appendChild(item.cloneNode(true));
            }
            historyEl.appendChild(item);
        });
    }

    async function loadEvents() {
        clearError("statusError");
        clearError("alarmsError");
        const yachtId = encodeURIComponent(getYachtId());
        try {
            const events = await apiGet("/yachts/" + yachtId + "/events?limit=100");
            cachedEvents = events || [];
            renderEvents(cachedEvents);
            renderAlarmsFromEvents(cachedEvents);
            updateLastEvent(cachedEvents);
        } catch (err) {
            console.error("Failed to load events", err);
            showError("statusError", "Failed to load events.");
            showError("alarmsError", "Failed to load events/alarms.");
        }
    }

    // --- AI LOGS ---

    function renderAiLogs(logs) {
        const list = document.getElementById("aiLogs");
        if (!list) return;
        list.innerHTML = "";

        if (!Array.isArray(logs) || logs.length === 0) {
            const div = document.createElement("div");
            div.className = "muted";
            div.textContent = "No AI logs yet.";
            list.appendChild(div);
            return;
        }

        logs.forEach(log => {
            const item = document.createElement("div");
            item.className = "log-item";

            const meta = document.createElement("div");
            meta.className = "log-meta";

            const pill = document.createElement("span");
            pill.className = "pill type-ai";
            pill.textContent = "AI";
            meta.appendChild(pill);

            const ts = document.createElement("span");
            ts.style.marginLeft = "6px";
            ts.textContent = log.generated_at || "";
            meta.appendChild(ts);

            if (log.mode) {
                const modeSpan = document.createElement("span");
                modeSpan.style.marginLeft = "6px";
                modeSpan.textContent = "mode: " + log.mode;
                meta.appendChild(modeSpan);
            }

            item.appendChild(meta);

            const body = document.createElement("div");
            body.className = "log-body";
            body.textContent = log.summary || "";
            item.appendChild(body);

            if (Array.isArray(log.actions) && log.actions.length > 0) {
                const details = document.createElement("div");
                details.className = "log-body muted";
                details.style.marginTop = "2px";
                details.textContent = log.actions.length + " action(s)";
                item.appendChild(details);
            }

            list.appendChild(item);
        });
    }

    async function loadAiLogs() {
        clearError("aiLogsError");
        const yachtId = encodeURIComponent(getYachtId());
        try {
            const logs = await apiGet("/yachts/" + yachtId + "/ai/logs?limit=50");
            renderAiLogs(logs);
        } catch (err) {
            console.error("Failed to load AI logs", err);
            showError("aiLogsError", "Failed to load AI logs.");
        }
    }

    // --- AI CHAT ---

    function appendChatEntry(role, text, when) {
        const box = document.getElementById("chatHistory");
        if (!box) return;
        const entry = document.createElement("div");
        entry.className = "chat-entry";

        const header = document.createElement("div");
        const strong = document.createElement("strong");
        strong.textContent = role.toUpperCase() + (when ? " (" + when + ")" : "");
        header.appendChild(strong);

        const p = document.createElement("p");
        p.textContent = text;

        entry.appendChild(header);
        entry.appendChild(p);
        box.appendChild(entry);
        box.scrollTop = box.scrollHeight;
    }

    async function sendChat() {
        clearError("chatError");
        const input = document.getElementById("chatInput");
        const msg = (input && input.value.trim()) || "";
        if (!msg) return;

        const yachtId = encodeURIComponent(getYachtId());
        appendChatEntry("you", msg, new Date().toISOString());
        input.value = "";

        try {
            const res = await apiPost("/yachts/" + yachtId + "/ai/chat", { message: msg });
            appendChatEntry("watchkeeper", res.reply || "(no reply)", res.created_at || "");
        } catch (err) {
            console.error("Chat error", err);
            showError("chatError", "Chat request failed.");
        }
    }

    // --- ALARMS ACTIONS (placeholders for now) ---

    function acknowledgeAlarms() {
        // No dedicated alarm API yet – this is a UI placeholder.
        alert("Alarm acknowledge is not wired to an API yet. Use events/logs to track alarms for now.");
    }

    function clearTestAlarms() {
        // No dedicated alarm clearing API – placeholder.
        alert("Clearing test alarms is not wired to an API yet.");
    }

    // --- GLOBAL REFRESH ---

    function refreshAll() {
        loadScenes();
        loadAiMode();
        loadDevices();
        loadEvents();
        loadAiLogs();
    }

    // --- INIT ---

    document.addEventListener("DOMContentLoaded", () => {
        refreshAll();
    });
</script>
=======
    /* INIT */

    (async function init() {
      await loadDevices();
      await loadScenes();
      await loadEvents();
      await loadAlarmEvents();
      setLastAction("UI ready");
    })();
  </script>
>>>>>>> parent of eab19c4 (1)
</body>
</html>
